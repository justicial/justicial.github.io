---
layout: post
date: 2025-02-22 20:00:00 +0300
title: "Uncovering CVE-2023-32422: How SQLite Logging Exposed macOS Privacy Protections"
description: "An in-depth look at how a forgotten SQLite logging feature in macOS led to a TCC database overwrite, granting attackers full control over macOS privacy settings."
tags: [SQLite, CVE-2023-32422, macOS, TCC.db, Security]
categories: Vulnerabilities
---

## Introduction

macOS has long been praised for its security measures, but sometimes overlooked debugging features can open critical vulnerabilities. One such case is **CVE-2023-32422**, which allowed attackers to exploit **SQLite’s SQL logging feature** (`SQLITE_SQLLOG_DIR`) to overwrite system-protected files, including `TCC.db`, a database responsible for macOS privacy controls.

This post explores how **Apple's forgotten debug functionality** led to a **full Transparency, Consent, and Control (TCC) bypass**, allowing unauthorized applications to gain Full Disk Access, read contacts, access the microphone, and more.

---

## **How the Exploit Worked**

### **1️⃣ Enabling SQL Logging to a Controlled Directory**

SQLite has a **documented logging feature** that logs SQL queries and **creates full database copies** when `SQLITE_SQLLOG_DIR` is set. This behavior is described in the [SQLite source file](https://www.sqlite.org/src/doc/trunk/src/test_sqllog.c), which explains how log files are generated. Attackers leveraged this by setting:

```sh
export SQLITE_SQLLOG_DIR=~/pwned/
open -a Music
```

✅ **Effect:** The Music app, which uses SQLite, **automatically saved a copy of its database** to `~/pwned/`, allowing attackers to manipulate it freely.

---

### **2️⃣ Preparing and Modifying the Logged Database**

After obtaining the database copy, the attacker **prepared a modified TCC.db** by merging it with the Music app’s `Cache.db` and injecting unauthorized permissions:

```sh
echo "[+] Preparing TCC.db"
echo "$TCCDB_SQL" | sqlite3 pwned/TCC.db
sqlite3 "~/Library/Caches/com.apple.Music/Cache.db" ".dump" | sqlite3 pwned/TCC.db
echo "[+] Overwriting target"
cat pwned/TCC.db > "~/Library/Caches/com.apple.Music/Cache.db"
```

✅ **Effect:** The attacker created a **new malicious TCC.db**, preserving expected database structures while injecting unauthorized entries.

✅ **Injected TCC Permissions:**

✔️ **Full access to user documents** (`kTCCServiceSystemPolicyDocumentsFolder`)

✔️ **Permission to modify system administrator files** (`kTCCServiceSystemPolicySysAdminFiles`)

✔️ **Authorization to send Apple Events to Finder** (`kTCCServiceAppleEvents`)

---

### **3️⃣ Overwriting the User’s TCC Database via Symlink**

Since SQLite **reuses filenames**, attackers created a **symlink to the user’s TCC database**:

```sh
ln -s ~/Library/Application\ Support/com.apple.TCC/TCC.db ~/pwned/sqllog_N.db
```

✅ **Effect:** When the Music app logged new queries, **SQLite unknowingly overwrote the user’s `TCC.db` with the attacker's version**.

---

### **4️⃣ Restarting TCC to Apply the Changes**

To force macOS to recognize the modified database, attackers restarted the TCC service:

```sh
launchctl stop com.apple.tccd
launchctl start com.apple.tccd
```

✅ **Effect:** The **maliciously modified TCC database** was now active, allowing **unauthorized access to protected user data**.

---

## **Apple’s Response and the Patch**

After **180 days** of investigation, Apple issued a patch that:
✔️ **Disabled `SQLITE_SQLLOG_DIR` in production builds.**

📌 **Takeaway:** This vulnerability proves how overlooked debugging features can become serious security risks.

---

## **Final Thoughts: The Bigger Picture**

This exploit underscores several critical security lessons:

✔️ **Leaving debugging features enabled in production software increases the attack surface.**

✔️ **Attackers can chain environment variable manipulation, symlink attacks, and database overwrites to escalate privileges.**

✔️ **While Apple patched `SQLITE_SQLLOG_DIR`, similar environment variable-based exploits or misconfigurations could still exist in other system apps.**

### **💡 Key Takeaways**

✔️ **Always review the impact of debugging features before shipping software.**

✔️ **Monitor environment variables that influence sensitive system operations.**

✔️ **Continuously test for insecure file-write operations, especially in apps with Full Disk Access.**

🚀 **As macOS security evolves, so do the attack vectors.** Stay informed, test regularly, and never assume a single patch fixes everything. The next big vulnerability might be just around the corner. 🔍🛡️
